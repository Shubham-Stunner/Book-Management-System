<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Book Manager</title>
  <script th:inline="javascript">
    // Reads Spring property: --api.base=... (or application.properties: api.base=...)
    window.API_BASE = /*[[${@environment.getProperty('api.base','')}]]*/ '';
  </script>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50 text-gray-900">
  <header class="max-w-6xl mx-auto px-4 py-6">
    <h1 class="text-2xl font-bold">ðŸ“š Book Management</h1>
    <p class="text-sm text-gray-600">List, add, edit and delete your books.</p>
  </header>

  <main class="max-w-6xl mx-auto px-4">
    <div class="flex justify-between items-center mb-4">
      <div class="text-sm text-gray-600" id="countInfo"></div>
      <button id="addBtn" class="px-4 py-2 rounded-xl bg-black text-white hover:opacity-90">+ Add Book</button>
    </div>

    <div class="overflow-hidden rounded-2xl shadow bg-white">
      <table class="min-w-full divide-y divide-gray-200" id="booksTable">
        <thead class="bg-gray-100">
          <tr>
            <th class="px-4 py-3 text-left text-xs font-semibold uppercase tracking-wider">Title</th>
            <th class="px-4 py-3 text-left text-xs font-semibold uppercase tracking-wider">Author</th>
            <th class="px-4 py-3 text-left text-xs font-semibold uppercase tracking-wider">ISBN</th>
            <th class="px-4 py-3 text-left text-xs font-semibold uppercase tracking-wider">Price</th>
            <th class="px-4 py-3 text-right text-xs font-semibold uppercase tracking-wider">Actions</th>
          </tr>
        </thead>
        <tbody class="divide-y divide-gray-100 bg-white" id="tbody"></tbody>
      </table>
    </div>

    <div id="toast" class="fixed bottom-6 right-6 hidden px-4 py-3 rounded-xl shadow text-white"></div>

    <div id="modal" class="fixed inset-0 bg-black/50 items-center justify-center hidden">
      <div class="bg-white rounded-2xl shadow w-full max-w-md p-6">
        <div class="flex items-center justify-between mb-4">
          <h2 id="modalTitle" class="text-lg font-semibold">Add Book</h2>
          <button id="closeModal" class="text-gray-500 hover:text-gray-700">âœ•</button>
        </div>
        <form id="bookForm" class="space-y-4">
          <input type="hidden" id="bookId" />
          <div>
            <label class="block text-sm font-medium mb-1" for="title">Title</label>
            <input id="title" class="w-full rounded-xl border-gray-300 focus:ring-2 focus:ring-black focus:border-black" required />
          </div>
          <div>
            <label class="block text-sm font-medium mb-1" for="author">Author</label>
            <input id="author" class="w-full rounded-xl border-gray-300 focus:ring-2 focus:ring-black focus:border-black" required />
          </div>
          <div>
            <label class="block text-sm font-medium mb-1" for="isbn">ISBN</label>
            <input id="isbn" class="w-full rounded-xl border-gray-300 focus:ring-2 focus:ring-black focus:border-black" required />
          </div>
          <div>
            <label class="block text-sm font-medium mb-1" for="price">Price</label>
            <input id="price" type="number" step="0.01" class="w-full rounded-xl border-gray-300 focus:ring-2 focus:ring-black focus:border-black" required />
          </div>
          <div class="flex justify-end gap-2 pt-2">
            <button type="button" id="cancelBtn" class="px-4 py-2 rounded-xl border">Cancel</button>
            <button type="submit" class="px-4 py-2 rounded-xl bg-black text-white">Save</button>
          </div>
        </form>
      </div>
    </div>
  </main>

    <script>
      const API = (p) => `${window.API_BASE}${p}`;

      async function refresh() {
        const r = await fetch(API('/api/books'));
        const list = await r.json();
        const tbody = document.getElementById('tbody');
        tbody.innerHTML = '';
        (Array.isArray(list) ? list : []).forEach(b => {
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td class="px-4 py-3">${b.title ?? ''}</td>
            <td class="px-4 py-3">${b.author ?? ''}</td>
            <td class="px-4 py-3">${b.isbn ?? ''}</td>
            <td class="px-4 py-3">â‚¹${Number(b.price ?? 0).toFixed(2)}</td>
            <td class="px-4 py-3 text-right">
              <button class="px-3 py-1 rounded-lg border mr-2" onclick="editBook('${b.id}')">Edit</button>
              <button class="px-3 py-1 rounded-lg bg-rose-600 text-white" onclick="deleteBook('${b.id}')">Delete</button>
            </td>`;
          tbody.appendChild(tr);
        });
        const ci = document.getElementById('countInfo'); if (ci) ci.textContent = `${(list||[]).length} book(s)`;
      }

      async function deleteBook(id) {
        if (!confirm('Delete this book?')) return;
        const r = await fetch(API(`/api/books/${id}`), { method: 'DELETE' });
        if (r.status === 204) { refresh(); }
        else { alert('Delete failed: ' + r.status + ' ' + await r.text()); }
      }

      // Minimal "Add" handler: form id=bookForm; inputs with ids: title, author, isbn, price
      const form = document.getElementById('bookForm');
      if (form) {
        form.addEventListener('submit', async (e) => {
          e.preventDefault();
          const payload = {
            title:  document.getElementById('title').value.trim(),
            author: document.getElementById('author').value.trim(),
            isbn:   document.getElementById('isbn').value.trim(),
            price:  Number(document.getElementById('price').value)
          };
          const r = await fetch(API('/api/books'), {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
          });
          if (r.status === 201) { form.reset(); refresh(); }
          else { alert('Save failed: ' + r.status + ' ' + await r.text()); }
        });
      }

      document.addEventListener('DOMContentLoaded', refresh);
    </script>
  </body>
</html>
